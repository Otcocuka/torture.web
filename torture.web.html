<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torture2 - Unified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Global Animations & Utils */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-red {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }

        .transition-standard {
            transition: all 0.2s ease-in-out;
        }

        /* View Switching */
        .app-view {
            display: none;
        }

        .app-view.active {
            display: block;
            animation: fade-in 0.3s ease-out;
        }

        /* Modal Styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            transition: all 0.2s;
        }

        .modal-visible {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            transition: all 0.2s;
        }

        /* Pomodoro Themes */
        .theme-work {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Red-100 */
        .theme-rest {
            background-color: #dcfce7;
            color: #166534;
        }

        /* Green-100 */

        /* Canvas Centering */
        .canvas-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å GitHub Style */
        .github-grid {
            display: grid;
            grid-template-columns: repeat(52, 12px);
            /* 52 –∫–æ–ª–æ–Ω–∫–∏ */
            grid-template-rows: repeat(7, 12px);
            /* 7 —Å—Ç—Ä–æ–∫ */
            gap: 2px;
            width: fit-content;
        }

        .github-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* –¶–≤–µ—Ç–∞ GitHub */
        .level-0 {
            background-color: #ebedf0;
        }

        /* –°–µ—Ä—ã–π */
        .level-1 {
            background-color: #9be9a8;
        }

        /* –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π */
        .level-2 {
            background-color: #40c463;
        }

        /* –ó–µ–ª–µ–Ω—ã–π */
        .level-3 {
            background-color: #30a14e;
        }

        /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π */
        .level-4 {
            background-color: #216e39;
        }

        /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π */
    </style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800 font-sans flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex justify-center space-x-1 p-1 bg-gray-100 rounded-lg mt-2 mb-2 w-fit mx-auto">
                <button data-nav="view-habits"
                    class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-standard hover:bg-white hover:shadow-sm text-gray-600">–ü—Ä–∏–≤—ã—á–∫–∏</button>
                <button data-nav="view-timer"
                    class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-standard hover:bg-white hover:shadow-sm text-gray-600">–¢–∞–π–º–µ—Ä</button>
                <button data-nav="view-wheel"
                    class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-standard hover:bg-white hover:shadow-sm text-gray-600">–ö–æ–ª–µ—Å–æ</button>
                <button data-nav="view-stats"
                    class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-standard hover:bg-white hover:shadow-sm text-gray-600">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <main class="flex-grow p-4 max-w-5xl mx-auto w-full">

        <!-- 1. HABITS VIEW -->
        <div id="view-habits" class="app-view">
            <div class="max-w-2xl mx-auto space-y-4">
                <!-- Add Habit Form -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex gap-2">
                        <input type="text" id="habitInput" placeholder="–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞..."
                            class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none">
                        <button id="habitSettingsBtn" class="p-2 text-gray-400 hover:text-blue-500" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <button id="addHabitBtn"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <!-- Stats Summary (Achievements Quick View) -->
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-lg font-semibold">–ú–æ–∏ –ü—Ä–∏–≤—ã—á–∫–∏</h2>
                    <button id="viewAchievementsBtn" class="text-sm text-green-600 font-medium hover:underline">üèÜ
                        –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
                </div>

                <!-- Habits List -->
                <div id="habitsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- 2. TIMER VIEW -->
        <div id="view-timer" class="app-view">
            <div class="max-w-2xl mx-auto">
                <!-- Main Timer Display -->
                <div id="timerContainer"
                    class="bg-white p-8 rounded-2xl shadow-lg text-center mb-6 transition-standard theme-work">
                    <h1 class="text-2xl font-bold mb-2 tracking-wide">POMODORO</h1>
                    <div id="timerDisplay" class="text-6xl md:text-8xl font-mono font-bold mb-4">25:00</div>
                    <div id="timerPhaseText" class="text-xl font-semibold uppercase tracking-widest opacity-80">–†–∞–±–æ—Ç–∞
                    </div>

                    <!-- Controls -->
                    <div class="mt-6 flex justify-center gap-3 flex-wrap">
                        <button id="timerStart"
                            class="px-6 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 shadow-md">Start</button>
                        <button id="timerPause" disabled
                            class="px-6 py-2 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 shadow-md opacity-50">Pause</button>
                        <button id="timerReset"
                            class="px-6 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 shadow-md">Reset</button>
                    </div>
                </div>

                <!-- Stats & Settings Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Stats -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2 text-gray-500 text-sm">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>–í—Å–µ–≥–æ: <span id="statSessions" class="font-bold">0</span></div>
                            <div>–†–∞–±–æ—Ç–∞: <span id="statWork" class="font-bold">0—Å</span></div>
                            <div>–ü–∞—É–∑–∞: <span id="statPaused" class="font-bold">0—Å</span></div>
                            <div>–û—Ç–¥—ã—Ö: <span id="statBreak" class="font-bold">0—Å</span></div>
                        </div>
                        <button id="resetStatsBtn"
                            class="mt-3 w-full text-xs text-red-500 border border-red-200 py-1 rounded hover:bg-red-50">–°–±—Ä–æ—Å
                            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
                    </div>

                    <!-- Settings -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2 text-gray-500 text-sm">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–∏–Ω)</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="text-xs flex flex-col">Work <input id="settingWork" type="number" value="25"
                                    class="border rounded px-1"></label>
                            <label class="text-xs flex flex-col">Short <input id="settingShort" type="number" value="5"
                                    class="border rounded px-1"></label>
                            <label class="text-xs flex flex-col">Long <input id="settingLong" type="number" value="15"
                                    class="border rounded px-1"></label>
                            <label class="text-xs flex flex-col">Every N <input id="settingCycle" type="number"
                                    value="4" class="border rounded px-1"></label>
                        </div>
                        <button id="saveTimerSettings"
                            class="mt-3 w-full text-xs bg-blue-100 text-blue-700 py-1 rounded hover:bg-blue-200">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. WHEEL VIEW -->
        <div id="view-wheel" class="app-view">
            <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md text-center">
                <h2 class="text-xl font-bold mb-1">–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</h2>
                <p class="text-sm text-gray-500 mb-4">–í—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>

                <div class="relative my-4 canvas-container">
                    <canvas id="wheelCanvas" width="300" height="300"
                        class="border-4 border-gray-100 rounded-full shadow-inner"></canvas>
                    <!-- Arrow -->
                    <div
                        class="absolute top-1/2 right-0 -translate-x-1/2 -translate-y-1/2 rotate-90 w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[25px] border-t-red-500 filter drop-shadow-md">
                    </div>
                </div>

                <div id="wheelResult"
                    class="text-lg font-bold text-indigo-600 min-h-[2.5rem] mb-4 flex items-center justify-center">
                    –ù–∞–∂–º–∏ "–ö—Ä—É—Ç–∏—Ç—å"
                </div>

                <button id="spinWheelBtn"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 shadow-lg w-full">–ö—Ä—É—Ç–∏—Ç—å</button>

                <div class="mt-4 pt-4 border-t text-xs text-gray-500">
                    –ò—Å—Ç–æ—Ä–∏—è: <span id="wheelHistoryCount">0</span> –ø—Ä–æ–∫—Ä—É—Ç–æ–∫
                </div>
            </div>
        </div>

        <!-- 4. STATS VIEW -->
        <div id="view-stats" class="app-view">
            <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

                <!-- Pomodoro Stats -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-blue-600 mb-3 flex items-center gap-2">
                        <span>üçÖ</span> Pomodoro
                    </h3>
                    <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg">
                        <div>
                            <div class="text-gray-500 text-sm">–°–µ—Å—Å–∏–π –≤—Å–µ–≥–æ</div>
                            <div class="text-2xl font-bold" id="stat-t-sessions">0</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-sm">–†–∞–±–æ—Ç–∞</div>
                            <div class="text-2xl font-bold text-blue-700" id="stat-t-work">0–º</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-sm">–û—Ç–¥—ã—Ö</div>
                            <div class="text-2xl font-bold text-green-600" id="stat-t-break">0–º</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-sm">–ü–∞—É–∑–∞</div>
                            <div class="text-2xl font-bold text-gray-600" id="stat-t-paused">0–º</div>
                        </div>
                    </div>
                </div>

                <!-- Habits Stats with Calendars -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-purple-600 mb-3">‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</h3>
                    <div class="bg-purple-50 p-4 rounded-lg space-y-4" id="stat-habits-container"></div>
                    <div id="calendar-months"
                        class="flex gap-1 justify-start min-w-[600px] mt-2 text-[10px] text-gray-400 ml-2"></div>
                </div>

                <!-- Wheel Stats -->
                <div>
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3 flex items-center gap-2">
                        <span>üé°</span> –ö–æ–ª–µ—Å–æ
                    </h3>
                    <div class="bg-indigo-50 p-4 rounded-lg space-y-2" id="stat-wheel-container">
                        <!-- –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
                        <div class="text-gray-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Section -->
        <div class="mt-8 p-4 border border-gray-300 rounded bg-gray-50 max-w-2xl mx-auto text-center">
            <h4 class="font-bold mb-2 text-gray-700">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
            <p class="text-xs text-gray-500 mb-2">–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.</p>
            <div class="flex gap-2 justify-center">
                <button id="btnExport"
                    class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">–°–∫–∞—á–∞—Ç—å JSON</button>
                <label class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm cursor-pointer">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
                    <input type="file" id="fileImport" accept=".json" class="hidden">
                </label>
            </div>
        </div>
    </main>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        /**
         * ------------------------------------------------------------------
         * 1. UNIFIED DATA STORE
         * ------------------------------------------------------------------
         */
        const Store = {
            key: 'torture2_data_v1',
            data: {
                habits: [],
                achievements: [],
                habitSettings: { goal: 5, color: 'blue' },
                tempSubtasks: [],
                pomodoro: {
                    stats: { totalSessions: 0, totalWork: 0, totalBreak: 0, totalPaused: 0 },
                    settings: { work: 25, short: 5, long: 15, longCycle: 4 }
                },
                wheel: { history: [] }
            },

            load() {
                try {
                    const raw = localStorage.getItem(this.key);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        // –ê–∫–∫—É—Ä–∞—Ç–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä
                        this.data.habits = parsed.habits || [];
                        this.data.achievements = parsed.achievements || [];
                        this.data.habitSettings = { ...this.data.habitSettings, ...parsed.habitSettings };
                        this.data.tempSubtasks = parsed.tempSubtasks || [];
                        this.data.pomodoro.stats = { ...this.data.pomodoro.stats, ...parsed.pomodoro?.stats };
                        this.data.pomodoro.settings = { ...this.data.pomodoro.settings, ...parsed.pomodoro?.settings };
                        this.data.wheel.history = parsed.wheel?.history || [];

                        console.log("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ LocalStorage.");
                        return true;
                    } else {
                        console.log("LocalStorage –ø—É—Å—Ç.");
                        return false;
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
                    alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message);
                    return false;
                }
            },

            save() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.data));
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ! –í–æ–∑–º–æ–∂–Ω–æ, –º–µ—Å—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∫–æ–Ω—á–∏–ª–æ—Å—å –∏–ª–∏ —Ä–µ–∂–∏–º –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ.");
                }
            },

            // --- HABITS ---
            addHabit(name) {
                this.data.habits.push({
                    id: Date.now(),
                    name,
                    count: 0,
                    goal: this.data.habitSettings.goal,
                    color: this.data.habitSettings.color,
                    subtasks: this.data.tempSubtasks.map(st => ({ ...st, dates: [] })),
                    history: []
                });
                this.data.tempSubtasks = [];
                this.save();
            },
            deleteHabit(id) {
                this.data.habits = this.data.habits.filter(h => h.id !== id);
                this.save();
            },
            incrementHabit(id) {
                const habit = this.data.habits.find(h => h.id === id);
                if (!habit) return;

                habit.count++;
                const today = new Date().toISOString().split('T')[0];
                const completedIds = habit.subtasks.filter(st => st.completed).map(st => st.id);
                habit.history.push({ date: today, subtasks: completedIds });

                habit.subtasks.forEach(st => {
                    if (st.completed) {
                        st.dates = st.dates || [];
                        st.dates.push(today);
                        st.completed = false;
                    }
                });

                if (habit.count >= habit.goal && !this.data.achievements.some(a => a.name === habit.name)) {
                    this.data.achievements.push({ name: habit.name, goal: habit.goal, date: today });
                    this.save();
                    return true;
                }
                this.save();
                return false;
            },
            toggleSubtask(habitId, subtaskId, status) {
                const habit = this.data.habits.find(h => h.id === habitId);
                if (habit) {
                    const st = habit.subtasks.find(s => s.id === subtaskId);
                    if (st) st.completed = status;
                    this.save();
                }
            },

            // --- POMODORO ---
            updatePomodoroSettings(settings) {
                this.data.pomodoro.settings = { ...this.data.pomodoro.settings, ...settings };
                this.save();
            },
            updatePomodoroStats(type, value) {
                this.data.pomodoro.stats[type] += value;
                this.save();
            },
            resetPomodoroStats() {
                this.data.pomodoro.stats = { totalSessions: 0, totalWork: 0, totalBreak: 0, totalPaused: 0 };
                this.save();
            },

            // --- WHEEL ---
            addToWheelHistory(activity) {
                this.data.wheel.history.push({ activity, date: new Date().toISOString() });
                this.save();
            }
        };

        /**
         * ------------------------------------------------------------------
         * 2. AUDIO ENGINE (Web Audio API - No External Files)
         * ------------------------------------------------------------------
         */
        const AudioEngine = {
            ctx: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playBeep() {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const oscillator = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, this.ctx.currentTime); // A5
                oscillator.frequency.exponentialRampToValueAtTime(440, this.ctx.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);

                oscillator.connect(gainNode);
                gainNode.connect(this.ctx.destination);

                oscillator.start();
                oscillator.stop(this.ctx.currentTime + 0.15);
            }
        };

        /**
         * ------------------------------------------------------------------
         * 3. POMODORO LOGIC
         * ------------------------------------------------------------------
         */
        class PomodoroController {
            constructor() {
                this.state = {
                    isRunning: false,
                    isWorking: true,
                    timeLeft: 0,
                    cycles: 0,
                    endTime: 0,
                    remainingPauseTime: 0,
                    lastPauseTime: 0,
                    interval: null
                };
            }

            init() {
                this.resetTimer(false);
            }

            getSettings() { return Store.data.pomodoro.settings; }

            start() {
                if (this.state.isRunning) return;
                this.state.isRunning = true;

                if (this.state.remainingPauseTime > 0) {
                    this.state.endTime = Date.now() + this.state.remainingPauseTime;
                    this.state.remainingPauseTime = 0;
                } else {
                    this.state.endTime = Date.now() + this.state.timeLeft * 1000;
                }

                Store.updatePomodoroStats('totalSessions', 1);
                UI.Timer.updateStats();

                this.state.interval = setInterval(() => this.tick(), 1000);
                UI.Timer.toggleControls(true);
            }

            pause() {
                if (!this.state.isRunning) {
                    const pausedDuration = Math.floor((Date.now() - this.state.lastPauseTime) / 1000);
                    Store.updatePomodoroStats('totalPaused', pausedDuration);
                    UI.Timer.updateStats();

                    this.state.isRunning = true;
                    this.state.endTime = Date.now() + this.state.remainingPauseTime;
                    this.state.interval = setInterval(() => this.tick(), 1000);
                    UI.Timer.toggleControls(true);
                } else {
                    this.state.isRunning = false;
                    this.state.lastPauseTime = Date.now();
                    this.state.remainingPauseTime = this.state.endTime - Date.now();
                    clearInterval(this.state.interval);
                    UI.Timer.toggleControls(false);
                }
            }

            reset(fullReset = true) {
                clearInterval(this.state.interval);
                this.state.isRunning = false;
                this.state.remainingPauseTime = 0;
                if (fullReset) {
                    this.state.cycles = 0;
                    this.state.isWorking = true;
                }
                this.resetTimer(false);
                UI.Timer.toggleControls(false);
            }

            resetTimer(keepState = true) {
                const settings = this.getSettings();
                if (!keepState) {
                    this.state.timeLeft = this.state.isWorking ? settings.work * 60 : settings.short * 60;
                } else {
                    if (this.state.isWorking) {
                        this.state.cycles++;
                        this.state.isWorking = false;
                        const isLong = this.state.cycles % settings.longCycle === 0;
                        this.state.timeLeft = (isLong ? settings.long : settings.short) * 60;
                        this.sendNotification("Break Time!", isLong ? "Long Break" : "Short Break");
                    } else {
                        this.state.isWorking = true;
                        this.state.timeLeft = settings.work * 60;
                        this.sendNotification("Work Time!", "Get back to it.");
                    }
                }
                AudioEngine.playBeep();
                UI.Timer.updateDisplay(this.state.timeLeft, this.state.isWorking);
            }

            tick() {
                const now = Date.now();
                let diff = Math.round((this.state.endTime - now) / 1000);
                if (diff < 0) diff = 0;
                this.state.timeLeft = diff;

                if (this.state.isWorking) Store.updatePomodoroStats('totalWork', 1);
                else Store.updatePomodoroStats('totalBreak', 1);

                UI.Timer.updateDisplay(this.state.timeLeft, this.state.isWorking);

                if (this.state.timeLeft <= 0) {
                    this.resetTimer(true);
                }
            }

            sendNotification(title, body) {
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification(title, { body, icon: '' });
                }
            }

            requestNotificationPermission() {
                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            }
        }

        /**
         * ------------------------------------------------------------------
         * 4. WHEEL LOGIC
         * ------------------------------------------------------------------
         */
        class WheelController {
            constructor() {
                this.isSpinning = false;
                this.rotation = 0;
                this.activities = [
                    { text: "1 –º–∏–Ω. –∑–∞—Ä—è–¥–∫–∏", color: "#60A5FA" },
                    { text: "–õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è", color: "#34D399" },
                    { text: "–û–±–Ω—è—Ç—å –ø–æ–¥—É—à–∫—É", color: "#FBBF24" },
                    { text: "–°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã", color: "#F87171" },
                    { text: "–†–∞—Å—Ç—è–∂–∫–∞", color: "#A78BFA" },
                    { text: "–î—ã—Ö–∞–Ω–∏–µ 1 –º–∏–Ω", color: "#F472B6" },
                    { text: "–£—Å–ø–µ—Ö", color: "#4ADE80" },
                    { text: "–ù—é—Ö–∞—Ç—å", color: "#86EFAC" },
                    { text: "–û–∫–Ω–æ", color: "#60A5FA" },
                    { text: "–£–±–æ—Ä–∫–∞", color: "#C084FC" }
                ];
                this.canvas = document.getElementById('wheelCanvas');
                this.ctx = this.canvas.getContext('2d');
            }

            draw() {
                if (!this.canvas) return;
                const w = this.canvas.width;
                const h = this.canvas.height;
                const cx = w / 2;
                const cy = h / 2;
                const r = cx - 10;
                const slice = (2 * Math.PI) / this.activities.length;

                this.ctx.clearRect(0, 0, w, h);

                this.ctx.save();
                this.ctx.translate(cx, cy);
                this.ctx.rotate(this.rotation);
                this.ctx.translate(-cx, -cy);

                this.activities.forEach((act, i) => {
                    const start = i * slice;
                    const end = start + slice;

                    this.ctx.beginPath();
                    this.ctx.moveTo(cx, cy);
                    this.ctx.arc(cx, cy, r, start, end);
                    this.ctx.closePath();
                    this.ctx.fillStyle = act.color;
                    this.ctx.fill();
                    this.ctx.strokeStyle = "white";
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();

                    // Text
                    this.ctx.save();
                    this.ctx.translate(cx, cy);
                    this.ctx.rotate(start + slice / 2);
                    this.ctx.textAlign = "right";
                    this.ctx.fillStyle = "white";
                    this.ctx.font = "bold 11px Arial";
                    this.ctx.fillText(act.text, r - 8, 4);
                    this.ctx.restore();
                });

                this.ctx.restore();
            }

            spin() {
                if (this.isSpinning) return;
                this.isSpinning = true;

                const selectedIndex = Math.floor(Math.random() * this.activities.length);
                const slice = (2 * Math.PI) / this.activities.length;
                const extraSpins = 5 * 2 * Math.PI;
                const targetRotation = extraSpins - (selectedIndex * slice + slice / 2);

                const startRotation = this.rotation;
                const duration = 4000;
                const startTime = performance.now();

                const animate = (curr) => {
                    const elapsed = curr - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 3);

                    this.rotation = startRotation + (targetRotation - startRotation) * ease;
                    this.draw();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.isSpinning = false;
                        const result = this.activities[selectedIndex].text;
                        const resEl = document.getElementById('wheelResult');
                        if (resEl) resEl.textContent = `üéâ ${result}`;
                        Store.addToWheelHistory(result);
                        const countEl = document.getElementById('wheelHistoryCount');
                        if (countEl) countEl.textContent = Store.data.wheel.history.length;
                    }
                };
                requestAnimationFrame(animate);
            }
        }

        /**
         * ------------------------------------------------------------------
         * 5. UI CONTROLLER
         * ------------------------------------------------------------------
         */
        const UI = {
            init() {
                // Navigation
                document.querySelectorAll('[data-nav]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.target.dataset.nav;
                        if (target === 'view-stats') UI.renderStatsView();
                        UI.switchView(target);
                        document.querySelectorAll('[data-nav]').forEach(b => b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600'));
                        e.target.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    });
                });

                // Start with Habits view
                this.switchView('view-habits');
                document.querySelector('[data-nav="view-habits"]').classList.add('bg-white', 'shadow-sm', 'text-blue-600');

                this.bindHabitsEvents();
                this.bindTimerEvents();
                this.bindWheelEvents();
                this.bindGlobalEvents();
                this.renderHabits();
            },

            switchView(viewId) {
                document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(viewId);
                if (target) target.classList.add('active');

                if (viewId === 'view-wheel' && window.Controllers.wheel) {
                    window.Controllers.wheel.draw();
                    const countEl = document.getElementById('wheelHistoryCount');
                    if (countEl) countEl.textContent = Store.data.wheel.history.length;
                }
            },

            // --- HABITS UI ---
            bindHabitsEvents() {
                document.getElementById('addHabitBtn').onclick = () => {
                    const input = document.getElementById('habitInput');
                    const name = input.value.trim();

                    if (name) {
                        // –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è, Store.addHabit —Å–∞–º –∑–∞–±–µ—Ä–µ—Ç tempSubtasks –∏ –æ—á–∏—Å—Ç–∏—Ç –∏—Ö
                        const hadAchievement = Store.addHabit(name);

                        input.value = '';
                        this.renderHabits();

                        if (hadAchievement) this.showNotification('üèÜ –ê—á–∏–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!');
                    }
                };

                document.getElementById('habitSettingsBtn').onclick = () => this.showHabitSettingsModal();
                document.getElementById('viewAchievementsBtn').onclick = () => this.showAchievementsModal();

                document.getElementById('habitsList').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const id = parseInt(target.dataset.id);

                    if (target.classList.contains('delete-btn')) {
                        this.showConfirmDelete(id);
                    } else if (target.dataset.action === 'increment') {
                        const hasAchievement = Store.incrementHabit(id);
                        this.renderHabits();
                        if (hasAchievement) this.showNotification('üèÜ –ê—á–∏–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!');
                    }
                });

                document.getElementById('habitsList').addEventListener('change', (e) => {
                    if (e.target.dataset.action === 'toggle-subtask') {
                        Store.toggleSubtask(
                            parseInt(e.target.dataset.habitId),
                            parseInt(e.target.dataset.subtaskId),
                            e.target.checked
                        );
                    }
                });
            },

            renderHabits() {
                const container = document.getElementById('habitsList');
                if (!container) return;
                const habits = Store.data.habits;
                if (habits.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</div>';
                    return;
                }

                container.innerHTML = habits.map(h => {
                    const color = h.color || 'blue';
                    return `
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-${color}-500 animate-fade-in">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold">${h.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">${h.count} –¥–Ω.</span>
                                    <button class="delete-btn text-gray-300 hover:text-red-500 text-lg px-2" data-id="${h.id}">√ó</button>
                                </div>
                            </div>
                            ${h.subtasks?.length ? `
                                <div class="space-y-1 ml-2 mb-2 pl-2 border-l border-gray-100">
                                    ${h.subtasks.map(st => `
                                        <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                            <input type="checkbox" class="rounded text-${color}-500"
                                                data-action="toggle-subtask" data-habit-id="${h.id}" data-subtask-id="${st.id}"
                                                ${st.completed ? 'checked' : ''}>
                                            <span class="${st.completed ? 'line-through text-gray-400' : ''}">${st.text}</span>
                                            <span class="text-xs text-gray-400">(${st.dates?.length || 0})</span>
                                        </label>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <button data-action="increment" data-id="${h.id}" class="w-full mt-2 py-1.5 rounded text-sm bg-${color}-100 text-${color}-800 hover:bg-${color}-200 font-medium">
                                –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                            </button>
                            ${h.history.length ? `
                                <details class="mt-2 text-xs text-gray-500">
                                    <summary class="cursor-pointer hover:text-blue-500">–ò—Å—Ç–æ—Ä–∏—è (${h.history.length})</summary>
                                    <div class="mt-1 bg-gray-50 p-2 rounded max-h-20 overflow-y-auto">
                                        ${h.history.slice(-3).reverse().map(hi => `
                                            <div>${new Date(hi.date).toLocaleDateString()}: ${hi.subtasks.length} –ø–æ–¥–ø.</div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            showHabitSettingsModal() {
                const s = Store.data.habitSettings;
                this.renderModal('settingsModal', `
                    <div class="bg-white rounded-lg p-6 w-80 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤—ã—á–µ–∫</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm block mb-1">–¶–µ–ª—å (–¥–Ω–µ–π)</label>
                                <input id="hGoal" type="number" value="${s.goal}" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-sm block mb-1">–¶–≤–µ—Ç</label>
                                <select id="hColor" class="w-full border p-2 rounded">
                                    <option value="blue" ${s.color === 'blue' ? 'selected' : ''}>–°–∏–Ω–∏–π</option>
                                    <option value="green" ${s.color === 'green' ? 'selected' : ''}>–ó–µ–ª–µ–Ω—ã–π</option>
                                    <option value="purple" ${s.color === 'purple' ? 'selected' : ''}>–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
                                </select>
                            </div>
                            <div class="border-t pt-3">
                                <label class="text-sm block mb-1">–ü–æ–¥–ø—É–Ω–∫—Ç—ã (–Ω–æ–≤—ã–µ)</label>
                                <div id="tempSubList" class="space-y-1 mb-2 max-h-20 overflow-y-auto text-xs"></div>
                                <div class="flex gap-1">
                                    <input id="tempSubInput" type="text" placeholder="–¢–µ–∫—Å—Ç..." class="flex-1 border p-1 rounded text-xs">
                                    <button id="addSubBtn" class="bg-gray-200 px-2 rounded hover:bg-gray-300">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end gap-2">
                            <button data-close-modal class="px-3 py-1 rounded hover:bg-gray-100">–û—Ç–º–µ–Ω–∞</button>
                            <button id="saveHSet" class="px-3 py-1 bg-blue-500 text-white rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `);

                const renderTemp = () => {
                    const list = document.getElementById('tempSubList');
                    if (!list) return;
                    list.innerHTML = Store.data.tempSubtasks.map(s => `
                        <div class="flex justify-between bg-gray-100 px-2 py-1 rounded">
                            <span>${s.text}</span>
                            <span class="cursor-pointer text-red-500" onclick="Store.data.tempSubtasks = Store.data.tempSubtasks.filter(x=>x.id!==${s.id}); UI.renderTempSubtasksInternal()">√ó</span>
                        </div>
                    `).join('');
                };
                this.renderTempSubtasksInternal = renderTemp;
                renderTemp();

                const addBtn = document.getElementById('addSubBtn');
                if (addBtn) {
                    addBtn.onclick = () => {
                        const val = document.getElementById('tempSubInput').value.trim();
                        if (val) {
                            Store.data.tempSubtasks.push({ id: Date.now(), text: val, completed: false });
                            document.getElementById('tempSubInput').value = '';
                            renderTemp();
                        }
                    };
                }

                const saveBtn = document.getElementById('saveHSet');
                if (saveBtn) {
                    saveBtn.onclick = () => {
                        const goalVal = document.getElementById('hGoal').value;
                        const colorVal = document.getElementById('hColor').value;
                        if (goalVal && colorVal) {
                            Store.data.habitSettings = {
                                goal: parseInt(goalVal) || 5,
                                color: colorVal
                            };
                            Store.save();
                            this.closeModal('settingsModal');
                        }
                    };
                }
            },

            showAchievementsModal() {
                const list = Store.data.achievements;
                const html = list.length
                    ? list.map(a => `<div class="flex justify-between bg-green-50 p-2 rounded"><span>${a.name}</span><span class="font-bold">x${a.goal}</span></div>`).join('')
                    : '<div class="text-gray-500 text-center">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';

                this.renderModal('achModal', `
                    <div class="bg-white rounded-lg p-6 w-80 max-h-[80vh] flex flex-col shadow-xl">
                        <h3 class="font-bold text-lg mb-2">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                        <div class="flex-1 overflow-y-auto space-y-2">${html}</div>
                        <button data-close-modal class="mt-4 w-full py-2 bg-gray-100 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `);
            },

            showConfirmDelete(id) {
                this.renderModal('confirm', `
                    <div class="bg-white rounded-lg p-6 w-72 text-center shadow-xl">
                        <p class="mb-4">–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É?</p>
                        <div class="flex justify-center gap-2">
                            <button data-close-modal class="px-3 py-1 bg-gray-100 rounded">–ù–µ—Ç</button>
                            <button id="doDelete" class="px-3 py-1 bg-red-500 text-white rounded">–î–∞</button>
                        </div>
                    </div>
                `);
                const btn = document.getElementById('doDelete');
                if (btn) {
                    btn.onclick = () => {
                        Store.deleteHabit(id);
                        this.closeModal('confirm');
                        this.renderHabits();
                    };
                }
            },

            // --- TIMER UI ---
            bindTimerEvents() {
                const startBtn = document.getElementById('timerStart');
                const pauseBtn = document.getElementById('timerPause');
                const resetBtn = document.getElementById('timerReset');
                const saveSetBtn = document.getElementById('saveTimerSettings');
                const resetStatBtn = document.getElementById('resetStatsBtn');

                if (startBtn) startBtn.onclick = () => window.Controllers.pomodoro.start();
                if (pauseBtn) pauseBtn.onclick = () => window.Controllers.pomodoro.pause();
                if (resetBtn) resetBtn.onclick = () => {
                    window.Controllers.pomodoro.reset(true);
                    this.updateStats();
                };

                if (saveSetBtn) {
                    saveSetBtn.onclick = () => {
                        const s = {
                            work: parseInt(document.getElementById('settingWork').value) || 25,
                            short: parseInt(document.getElementById('settingShort').value) || 5,
                            long: parseInt(document.getElementById('settingLong').value) || 15,
                            longCycle: parseInt(document.getElementById('settingCycle').value) || 4
                        };
                        Store.updatePomodoroSettings(s);
                        window.Controllers.pomodoro.reset(true);
                        this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
                    };
                }

                if (resetStatBtn) {
                    resetStatBtn.onclick = () => {
                        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
                            Store.resetPomodoroStats();
                            this.updateStats();
                        }
                    };
                }

                if (startBtn) {
                    startBtn.addEventListener('click', () => window.Controllers.pomodoro.requestNotificationPermission(), { once: true });
                }
            },

            updateTimerDisplay(mins, secs, isWorking) {
                const display = document.getElementById('timerDisplay');
                const phase = document.getElementById('timerPhaseText');
                const container = document.getElementById('timerContainer');

                if (display) display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (isWorking) {
                    if (phase) phase.textContent = "–†–ê–ë–û–¢–ê";
                    if (container) container.className = "bg-white p-8 rounded-2xl shadow-lg text-center mb-6 transition-standard theme-work";
                } else {
                    if (phase) phase.textContent = "–û–¢–î–´–•";
                    if (container) container.className = "bg-white p-8 rounded-2xl shadow-lg text-center mb-6 transition-standard theme-rest";
                }
            },

            updateStats() {
                const s = Store.data.pomodoro.stats;
                const el = document.getElementById('statSessions');
                if (el) el.textContent = s.totalSessions;
                const el2 = document.getElementById('statWork');
                if (el2) el2.textContent = this.formatDuration(s.totalWork);
                const el3 = document.getElementById('statBreak');
                if (el3) el3.textContent = this.formatDuration(s.totalBreak);
                const el4 = document.getElementById('statPaused');
                if (el4) el4.textContent = s.totalPaused + '—Å';
            },

            formatDuration(sec) {
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
            },

            Timer: {
                toggleControls(isRunning) {
                    const start = document.getElementById('timerStart');
                    const pause = document.getElementById('timerPause');
                    if (start) {
                        start.disabled = isRunning;
                        start.style.opacity = isRunning ? 0.5 : 1;
                    }
                    if (pause) {
                        pause.disabled = !isRunning;
                        pause.style.opacity = !isRunning ? 0.5 : 1;
                    }
                },
                updateDisplay(timeLeft, isWorking) {
                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    UI.updateTimerDisplay(m, s, isWorking);
                },
                updateStats() { UI.updateStats(); }
            },

            // --- WHEEL UI ---
            bindWheelEvents() {
                const btn = document.getElementById('spinWheelBtn');
                if (btn) btn.onclick = () => window.Controllers.wheel.spin();
            },

            // --- MODAL SYSTEM ---
            renderModal(id, html) {
                const container = document.getElementById('modalContainer');
                if (!container) return;
                container.innerHTML = `
                    <div id="modal_${id}" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 modal-hidden" onclick="if(event.target===this) UI.closeModal('${id}')">
                        <div class="transform transition-all scale-95 opacity-0" id="modal_content_${id}">
                            ${html}
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    const wrap = document.getElementById(`modal_${id}`);
                    const content = document.getElementById(`modal_content_${id}`);
                    if (wrap && content) {
                        wrap.classList.remove('modal-hidden');
                        content.classList.remove('scale-95', 'opacity-0');
                    }
                }, 10);
            },

            closeModal(id) {
                const wrap = document.getElementById(`modal_${id}`);
                const content = document.getElementById(`modal_content_${id}`);
                if (wrap && content) {
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        wrap.classList.add('modal-hidden');
                        wrap.remove();
                    }, 200);
                }
            },

            showNotification(msg) {
                const n = document.createElement('div');
                n.className = "fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in z-[60]";
                n.textContent = msg;
                document.body.appendChild(n);
                setTimeout(() => n.remove(), 3000);
            },

            // --- HELPER: Generate Calendar Grid HTML ---

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ—Ç–∫—É –î–ù–ï–ô –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–∏
            generateCalendarGrid(habit) {
                const today = new Date();
                const toISO = (d) => d.toISOString().split('T')[0];

                // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—ã –∏–∑ history —ç—Ç–æ–π –ø—Ä–∏–≤—ã—á–∫–∏
                const dateMap = {};
                if (habit.history) {
                    habit.history.forEach(rec => {
                        // rec.date —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ "YYYY-MM-DD"
                        // –ï—Å–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å >1 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å, —Å—É–º–º–∏—Ä—É–µ–º (—Ä–µ–¥–∫–æ, –Ω–æ –±—ã–≤–∞–µ—Ç)
                        dateMap[rec.date] = (dateMap[rec.date] || 0) + 1;
                    });
                }

                // 2. –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (52 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥)
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - (52 * 7));

                let gridHtml = '';

                // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 52 –∫–æ–ª–æ–Ω–æ–∫ (–Ω–µ–¥–µ–ª—å)
                for (let w = 0; w < 52; w++) {
                    for (let d = 0; d < 7; d++) {
                        const cellDate = new Date(startDate);
                        cellDate.setDate(startDate.getDate() + (w * 7) + d);

                        if (cellDate > today) {
                            gridHtml += '<div class="w-[10px] h-[10px]"></div>'; // –ü—É—Å—Ç–æ—Ç–∞
                            continue;
                        }

                        const iso = toISO(cellDate);
                        const count = dateMap[iso] || 0;

                        // –¶–≤–µ—Ç–∞ (0: —Å–µ—Ä—ã–π, 1: —Å–≤–µ—Ç–ª—ã–π, 2: —Å—Ä–µ–¥–Ω–∏–π, 3+: —Ç–µ–º–Ω—ã–π)
                        let colorClass = "bg-gray-200";
                        if (count === 1) colorClass = "bg-green-300";
                        if (count === 2) colorClass = "bg-green-500";
                        if (count >= 3) colorClass = "bg-green-700";

                        gridHtml += `<div class="w-[10px] h-[10px] rounded-[2px] ${colorClass}" title="${iso}: ${count} –≤—ã–ø–æ–ª–Ω."></div>`;
                    }
                }
                return gridHtml;
            },

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∏ –º–µ—Å—è—Ü–µ–≤ (Jan, Feb...)
            renderCalendarMonths() {
                const container = document.getElementById('calendar-months');
                if (!container) return;

                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - (52 * 7)); // –ù–∞—á–∞–ª–æ 52 –Ω–µ–¥–µ–ª—å –Ω–∞–∑–∞–¥

                // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç–∞—Ä—Ç –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫—É
                // 0=–í—Å, 1=–ü–Ω... –ï—Å–ª–∏ –Ω–µ –ü–Ω, —Å–¥–≤–∏–≥–∞–µ–º –¥–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ü–Ω
                let day = startDate.getDay();
                if (day === 0) day = 7;
                startDate.setDate(startDate.getDate() - day + 1);

                let html = '';
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ 52 –Ω–µ–¥–µ–ª—è–º, –∏—â–µ–º –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞
                for (let i = 0; i < 52; i++) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + (i * 7));

                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è –º–µ—Å—è—Ü–∞ (–¥–µ–Ω—å < 8) –∏–ª–∏ —ç—Ç–æ —Å–∞–º–∞—è –ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è (i=0)
                    if (d.getDate() <= 7 || i === 0) {
                        // –ü–∏—à–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
                        const monthStr = d.toLocaleString('ru-RU', { month: 'short' });
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º, —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª–∏—Ç—å
                        html += `<span style="margin-right: 22px; font-weight: bold;">${monthStr}</span>`;
                    }
                }
                container.innerHTML = html;
            },
            // --- STATS VIEW (Updated) ---
            // --- STATS VIEW (Updated) ---
            // --- STATS VIEW (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
            renderStatsView() {
                // 1. Pomodoro
                const p = Store.data.pomodoro.stats;
                const s1 = document.getElementById('stat-t-sessions'); if (s1) s1.textContent = p.totalSessions;
                const s2 = document.getElementById('stat-t-work'); if (s2) s2.textContent = this.formatDuration(p.totalWork);
                const s3 = document.getElementById('stat-t-break'); if (s3) s3.textContent = this.formatDuration(p.totalBreak);
                const s4 = document.getElementById('stat-t-paused'); if (s4) s4.textContent = p.totalPaused + '—Å';

                // 2. Habits
                const hCont = document.getElementById('stat-habits-container');
                const habits = Store.data.habits;

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–µ–π –º–µ—Å—è—Ü–µ–≤ (–ø—Ä–æ—Å—Ç–æ –¥–ª—è –≤–∏–¥–∞)
                const mContainer = document.getElementById('calendar-months');
                if (mContainer) {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 12 –ø–æ–¥–ø–∏—Å–µ–π
                    let mHtml = '';
                    for (let i = 0; i < 12; i++) mHtml += `<span style="width:30px">${i + 1}</span>`;
                    mContainer.innerHTML = mHtml;
                }

                if (hCont) {
                    if (habits.length === 0) {
                        hCont.innerHTML = '<div class="text-gray-500 text-sm">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫</div>';
                    } else {
                        hCont.innerHTML = habits.map(habit => {
                            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π –∑–∞ –¥–∞—Ç—É
                            const today = new Date();
                            const map = {};
                            if (habit.history) {
                                habit.history.forEach(h => {
                                    map[h.date] = (map[h.date] || 0) + 1;
                                });
                            }

                            // –†–µ–Ω–¥–µ—Ä 365 –¥–Ω–µ–π
                            let html = '';
                            for (let i = 0; i < 365; i++) {
                                const d = new Date(today);
                                d.setDate(today.getDate() - i);
                                const iso = d.toISOString().split('T')[0];

                                // --- –õ–û–ì–ò–ö–ê –¶–í–ï–¢–û–í ---
                                const count = map[iso] || 0;
                                let colorClass = 'bg-gray-200'; // –£—Ä–æ–≤–µ–Ω—å 0 (–Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π)

                                if (count >= 1) colorClass = 'bg-green-300'; // level-1
                                if (count >= 2) colorClass = 'bg-green-500'; // level-2
                                if (count >= 3) colorClass = 'bg-green-600'; // level-3
                                if (count >= 4) colorClass = 'bg-green-800'; // level-4+ (—Ç–µ–º–Ω–µ–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞)
                                // ---------------------

                                html += `<div class="w-[10px] h-[10px] rounded-[2px] ${colorClass}" title="${iso}: ${count} —Ä–∞–∑"></div>`;
                            }

                            // –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –í–ê–®–£ –†–ê–°–°–¢–ê–ù–û–í–ö–£
                            // scale-y-[-1] + direction: rtl –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ —Å–Ω–∏–∑—É-—Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö-–≤–ª–µ–≤–æ
                            return `
                                <div class="bg-white p-3 rounded-lg border border-purple-100 shadow-sm mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold text-gray-800">${habit.name}</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">–î–Ω–µ–π: ${habit.count}</span>
                                    </div>
                                    <div class="flex  h-auto">
                                        <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">
                                            
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>    
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] h-[82px] text-[8px]">days</div>
                                            
                                        </div>
                                        <div class="overflow-x-auto scale-y-[-1]" style="direction: rtl;">
                                            <div class="grid grid-rows-7 grid-flow-col gap-[2px] w-max">
                                                ${html}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Wheel (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                const wCont = document.getElementById('stat-wheel-container');
                if (wCont) {
                    const history = Store.data.wheel.history;
                    if (history.length === 0) {
                        wCont.innerHTML = '<div class="text-gray-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                    } else {
                        const counts = {};
                        history.forEach(h => counts[h.activity] = (counts[h.activity] || 0) + 1);
                        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
                        wCont.innerHTML = `<div class="text-xs text-gray-500 mb-2">–í—Å–µ–≥–æ –ø—Ä–æ–∫—Ä—É—Ç–æ–∫: ${history.length}</div>` +
                            sorted.map(([name, count]) => `<div class="flex justify-between items-center text-sm"><span class="text-gray-700">${name}</span><span class="text-indigo-600 font-bold">${count} —Ä–∞–∑</span></div>`).join('');
                    }
                }
            },

            // --- GLOBAL EVENTS (Import/Export) ---
            bindGlobalEvents() {
                // Export
                document.getElementById('btnExport')?.addEventListener('click', (e) => {
                    const dataStr = JSON.stringify(Store.data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `torture2_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // Import
                document.getElementById('fileImport')?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const json = JSON.parse(event.target.result);
                            if (json && typeof json === 'object') {
                                Store.data = { ...Store.data, ...json };
                                Store.save();
                                location.reload();
                            } else {
                                alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!");
                            }
                        } catch (err) {
                            alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err);
                        }
                    };
                    reader.readAsText(file);
                });
            }
        };

        /**
         * ------------------------------------------------------------------
         * 6. INITIALIZATION
         * ------------------------------------------------------------------
         */
        window.addEventListener('DOMContentLoaded', () => {
            // 1. Load Data
            const hasData = Store.load();

            // 2. Recovery Logic
            if (!hasData) {
                const choice = confirm("–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã.\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (JSON) –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?");
                if (choice) {
                    document.getElementById('fileImport')?.click();
                    return;
                }
            }

            // 3. Init Controllers
            window.Controllers = {
                pomodoro: new PomodoroController(),
                wheel: new WheelController()
            };

            // 4. Init UI
            UI.init();

            // 5. Populate Inputs
            const s = Store.data.pomodoro.settings;
            const wIn = document.getElementById('settingWork');
            if (wIn) wIn.value = s.work;
            const shIn = document.getElementById('settingShort');
            if (shIn) shIn.value = s.short;
            const lIn = document.getElementById('settingLong');
            if (lIn) lIn.value = s.long;
            const cIn = document.getElementById('settingCycle');
            if (cIn) cIn.value = s.longCycle;

            // 6. Init Logic
            UI.renderHabits();
            window.Controllers.pomodoro.init();
            UI.updateStats();
            window.Controllers.wheel.draw();
        });
    </script>
</body>

</html>